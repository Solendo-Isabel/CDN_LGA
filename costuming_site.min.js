const Iframe_id = "Comunica";
const Close_image = "./Comunica_Close.svg";
const Open_image = "./Comunica_Open.svg";

// Create iframe
const IFRAME = document.createElement("iframe");
IFRAME.setAttribute("frameborder", 0);
IFRAME.id = Iframe_id;

// Create floating button
const floatingButton = document.createElement("button");
floatingButton.classList.add("UnClickable");
floatingButton.id = "floatingButton";

// Add image to the button
const IMAGE = document.createElement("img");
IMAGE.setAttribute("src", Open_image);
IMAGE.classList.add("Unclickable");
IMAGE.id = "floatingButtonImage";
floatingButton.appendChild(IMAGE);

// Append to DOM
document.body.appendChild(floatingButton);
document.body.appendChild(IFRAME);

// Make elements clickable
const setClickable = (Pointer) => {
  if (IFRAME.style.display === "block") {
    if (Pointer.target.id !== "floatingButtonImage" && Pointer.target.id !== "floatingButton") {
      Pointer.target.classList.add("Clickable");
    }
  }
};

const removeClickable = (Pointer) => {
  if (IFRAME.style.display === "block") {
    Pointer.target.classList.remove("Clickable");
  }
};

// Send structured message with text
const sendInput = (Pointer) => {
  if (IFRAME.style.display === "block") {
    if (
      Pointer.target.classList.contains("Clickable") &&
      Pointer.target.id !== "floatingButtonImage" &&
      Pointer.target.id !== "floatingButton"
    ) {
      const message = {
        type: "text",
        text: Pointer.target.textContent
      };
      IFRAME.contentWindow.postMessage(message, "*");
      console.log("Sent text to iframe:", message.text);
    }
  }
};

// Show/hide iframe
const showPlayer = () => {
  if (IFRAME.style.display === "none" || IFRAME.style.display === "") {
    IFRAME.setAttribute("src", "http://127.0.0.1:7000/player/app");
    IFRAME.style.display = "block";
    IMAGE.setAttribute("src", Close_image);
  } else {
    IFRAME.style.display = "none";
    IMAGE.setAttribute("src", Open_image);
  }
};

// Listen for messages from iframe
window.addEventListener("message", (event) => {
  if (event.data.type === "tokenRequest") {
    console.log("Iframe requested token, sending it...");
    event.source.postMessage({ type: "sendToken", token: API_TOKEN }, "*");
  }
});

// Register event handlers
IFRAME.onload = () => {
  document.body.addEventListener("mouseover", setClickable);
  document.body.addEventListener("mouseout", removeClickable);
  document.body.addEventListener("click", sendInput);
};

IMAGE.addEventListener("click", showPlayer);

// Manual API to send text to iframe (optional use)
const sendTextToIframe = (text) => {
  const iframe = document.getElementById(Iframe_id);
  iframe.contentWindow.postMessage({ type: "text", text: text }, "*");
};
